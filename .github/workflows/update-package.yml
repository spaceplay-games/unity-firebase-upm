name: Update Package (Reusable)

on:
  workflow_call:
    inputs:
      package_name:
        description: 'Package name (e.g., com.google.firebase.crashlytics)'
        required: true
        type: string
      package_type:
        description: 'Package type: firebase or edm'
        required: false
        type: string
        default: 'firebase'
    secrets:
      REPO_TOKEN:
        description: 'Token with repo access'
        required: false

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      latest_version: ${{ steps.get-version.outputs.version }}
      current_version: ${{ steps.current-version.outputs.version }}
      should_update: ${{ steps.compare.outputs.should_update }}
    steps:
      - uses: actions/checkout@v4

      - name: Get latest version
        id: get-version
        run: |
          if [ "${{ inputs.package_type }}" == "edm" ]; then
            # EDM4U version from GitHub releases
            VERSION=$(curl -s https://api.github.com/repos/googlesamples/unity-jar-resolver/releases/latest | jq -r '.tag_name' | sed 's/v//')
          else
            # Firebase version from GitHub releases
            VERSION=$(curl -s https://api.github.com/repos/firebase/firebase-unity-sdk/releases/latest | jq -r '.tag_name' | sed 's/v//')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Latest version: $VERSION"

      - name: Get current version from package.json
        id: current-version
        run: |
          if [ -f "package.json" ]; then
            CURRENT=$(jq -r '.version' package.json)
          else
            CURRENT="0.0.0"
          fi
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT"

      - name: Compare versions
        id: compare
        run: |
          if [ "${{ steps.get-version.outputs.version }}" != "${{ steps.current-version.outputs.version }}" ]; then
            echo "should_update=true" >> $GITHUB_OUTPUT
            echo "New version available"
          else
            echo "should_update=false" >> $GITHUB_OUTPUT
            echo "Already up to date"
          fi

  update-package:
    needs: check-version
    if: needs.check-version.outputs.should_update == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Download and extract package
        run: |
          VERSION="${{ needs.check-version.outputs.latest_version }}"
          PKG="${{ inputs.package_name }}"

          echo "Downloading ${PKG} v${VERSION}..."

          # Download from Google's registry
          URL="https://dl.google.com/games/registry/unity/${PKG}/${PKG}-${VERSION}.tgz"

          if curl -L -f -o "package.tgz" "$URL"; then
            echo "Downloaded successfully"

            # Extract to temp directory
            mkdir -p temp_extract
            tar -xzf package.tgz -C temp_extract --strip-components=1

            # Remove old files (except .git and .github)
            find . -maxdepth 1 ! -name '.' ! -name '.git' ! -name '.github' ! -name 'temp_extract' -exec rm -rf {} +

            # Move new files to root
            mv temp_extract/* .
            rm -rf temp_extract package.tgz

            echo "Extracted ${PKG} v${VERSION}"
          else
            echo "Failed to download package"
            exit 1
          fi

      - name: Add missing meta files
        run: |
          VERSION="${{ needs.check-version.outputs.latest_version }}"

          # Find EXCLUDED_FILES.md files without corresponding .meta files and create them
          find . -name "EXCLUDED_FILES.md" -type f | while read -r file; do
            meta_file="${file}.meta"
            if [ ! -f "$meta_file" ]; then
              # Get relative path for export path label
              rel_path="${file#./}"

              # Generate a deterministic GUID based on the file path
              guid=$(echo -n "$rel_path" | md5sum | cut -c1-32)

              echo "Creating missing meta file: $meta_file"
              printf 'fileFormatVersion: 2\nguid: %s\nlabels:\n- gvh\n- gvh_version-%s\n- gvhp_exportpath-%s\ntimeCreated: 0\n' "$guid" "$VERSION" "$rel_path" > "$meta_file"
            fi
          done

      - name: Commit and push changes
        run: |
          VERSION="${{ needs.check-version.outputs.latest_version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Update to v${VERSION}"
          git push origin main

      - name: Create release
        run: |
          VERSION="${{ needs.check-version.outputs.latest_version }}"

          # Create and push tag
          git tag "$VERSION"
          git push origin "$VERSION"

          # Create GitHub release
          gh release create "$VERSION" \
            --title "$VERSION" \
            --notes "**Full Changelog**: https://github.com/${{ github.repository }}/commits/${VERSION}"
        env:
          GH_TOKEN: ${{ secrets.REPO_TOKEN || secrets.GITHUB_TOKEN }}
